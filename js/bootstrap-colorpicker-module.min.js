angular.module("colorpicker.module",[]).factory("Helper",function(){"use strict";return{closestSlider:function(e){var o=e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector;return o.bind(e)("I")?e.parentNode:e},getOffset:function(e,o){for(var t=0,r=0,n=e.getBoundingClientRect();e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop);)o||"BODY"!==e.tagName?(t+=e.scrollLeft,r+=e.scrollTop):(t+=document.documentElement.scrollLeft||e.scrollLeft,r+=document.documentElement.scrollTop||e.scrollTop),e=e.offsetParent;return{top:n.top+window.pageYOffset,left:n.left+window.pageXOffset,scrollX:t,scrollY:r}},stringParsers:[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[e[1],e[2],e[3],e[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[2.55*e[1],2.55*e[2],2.55*e[3],e[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,parse:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,parse:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}}]}}).factory("Color",["Helper",function(e){"use strict";return{value:{h:1,s:1,b:1,a:1},rgb:function(){var e=this.toRGB();return"rgb("+e.r+","+e.g+","+e.b+")"},rgba:function(){var e=this.toRGB();return"rgba("+e.r+","+e.g+","+e.b+","+e.a+")"},hex:function(){return this.toHex()},RGBtoHSB:function(e,o,t,r){e/=255,o/=255,t/=255;var n,l,a,c;return a=Math.max(e,o,t),c=a-Math.min(e,o,t),n=0===c?null:a===e?(o-t)/c:a===o?(t-e)/c+2:(e-o)/c+4,n=(n+360)%6*60/360,l=0===c?0:c/a,{h:n||1,s:l,b:a,a:r||1}},setColor:function(o){o=o?o.toLowerCase():o;for(var t in e.stringParsers)if(e.stringParsers.hasOwnProperty(t)){var r=e.stringParsers[t],n=r.re.exec(o),l=n&&r.parse(n);if(l)return this.value=this.RGBtoHSB.apply(null,l),!1}},setHue:function(e){this.value.h=1-e},setSaturation:function(e){this.value.s=e},setLightness:function(e){this.value.b=1-e},setAlpha:function(e){this.value.a=parseInt(100*(1-e),10)/100},toRGB:function(e,o,t,r){e||(e=this.value.h,o=this.value.s,t=this.value.b),e*=360;var n,l,a,c,i;return e=e%360/60,i=t*o,c=i*(1-Math.abs(e%2-1)),n=l=a=t-i,e=~~e,n+=[i,c,0,0,c,i][e],l+=[c,i,i,c,0,0][e],a+=[0,0,c,i,i,c][e],{r:Math.round(255*n),g:Math.round(255*l),b:Math.round(255*a),a:r||this.value.a}},toHex:function(e,o,t,r){var n=this.toRGB(e,o,t,r);return"#"+(1<<24|parseInt(n.r,10)<<16|parseInt(n.g,10)<<8|parseInt(n.b,10)).toString(16).substr(1)}}}]).factory("Slider",["Helper",function(e){"use strict";var o={maxLeft:0,maxTop:0,callLeft:null,callTop:null,knob:{top:0,left:0}},t={};return{getSlider:function(){return o},getLeftPosition:function(e){return Math.max(0,Math.min(o.maxLeft,o.left+((e.pageX||t.left)-t.left)))},getTopPosition:function(e){return Math.max(0,Math.min(o.maxTop,o.top+((e.pageY||t.top)-t.top)))},setSlider:function(r,n){var l=e.closestSlider(r.target),a=e.getOffset(l,n),c=l.getBoundingClientRect(),i=r.clientX-c.left,s=r.clientY-c.top;o.knob=l.children[0].style,o.left=r.pageX-a.left-window.pageXOffset+a.scrollX,o.top=r.pageY-a.top-window.pageYOffset+a.scrollY,t={left:r.pageX-(i-o.left),top:r.pageY-(s-o.top)}},setSaturation:function(e,t,r){o={maxLeft:r,maxTop:r,callLeft:"setSaturation",callTop:"setLightness"},this.setSlider(e,t)},setHue:function(e,t,r){o={maxLeft:0,maxTop:r,callLeft:!1,callTop:"setHue"},this.setSlider(e,t)},setAlpha:function(e,t,r){o={maxLeft:0,maxTop:r,callLeft:!1,callTop:"setAlpha"},this.setSlider(e,t)},setKnob:function(e,t){o.knob.top=e+"px",o.knob.left=t+"px"}}}]).directive("colorpicker",["$document","$compile","Color","Slider","Helper",function(e,o,t,r,n){"use strict";return{require:"?ngModel",restrict:"A",link:function(l,a,c,i){function s(){e.on("mousemove",p),e.on("mouseup",f)}function u(){try{V.css("backgroundColor",M[w]())}catch(e){V.css("backgroundColor",M.toHex())}F.css("backgroundColor",M.toHex(M.value.h,1,1,1)),"rgba"===w&&(x.css.backgroundColor=M.toHex())}function p(e){var o=r.getLeftPosition(e),t=r.getTopPosition(e),n=r.getSlider();r.setKnob(t,o),n.callLeft&&M[n.callLeft].call(M,o/L),n.callTop&&M[n.callTop].call(M,t/L),H&&"setHue"===n.callTop&&(M.setSaturation.call(M,1),M.setLightness.call(M,0)),u();var c=M[w]();return a.val(c),i&&l.$apply(i.$setViewValue(c)),C&&G.val(c),!1}function f(){v("colorpicker-selected"),e.off("mousemove",p),e.off("mouseup",f)}function d(e){M.value=B,M.setColor(a.val()),C&&!e&&G.val(a.val()),h(),u()}function h(){Y.eq(0).css({left:M.value.s*L+"px",top:L-M.value.b*L+"px"}),Y.eq(1).css("top",L*(1-M.value.h)+"px"),Y.eq(2).css("top",L*(1-M.value.a)+"px"),B=M.value,u()}function k(){var e,o=n.getOffset(a[0]),t=2;return angular.isDefined(c.colorpickerParent)&&(o.left=0,o.top=0),"top"===$?e={top:o.top-X-t,left:o.left}:"right"===$?e={top:o.top,left:o.left+a[0].offsetWidth+t}:"bottom"===$?e={top:o.top+a[0].offsetHeight+t,left:o.left}:"left"===$&&(e={top:o.top,left:o.left-R-t}),{top:e.top+"px",left:e.left+"px"}}function g(){m()}function b(){N||A.hasClass("colorpicker-visible")||(d(),A.addClass("colorpicker-visible").css(k()),v("colorpicker-shown"),y===!1&&e.on("mousedown",g),c.colorpickerIsOpen&&(l[c.colorpickerIsOpen]=!0,l.$$phase&&l.$root.$$phase||l.$digest()))}function v(e){i&&l.$emit(e,{name:c.ngModel,value:i.$modelValue})}function m(){A.hasClass("colorpicker-visible")&&(A.removeClass("colorpicker-visible"),v("colorpicker-closed"),e.off("mousedown",g),c.colorpickerIsOpen&&(l[c.colorpickerIsOpen]=!1,l.$$phase&&l.$root.$$phase||l.$digest()))}var x,w=c.colorpicker?c.colorpicker:"hex",$=angular.isDefined(c.colorpickerPosition)?c.colorpickerPosition:"bottom",y=!!angular.isDefined(c.colorpickerInline)&&c.colorpickerInline,S=!!angular.isDefined(c.colorpickerFixedPosition)&&c.colorpickerFixedPosition,I=angular.isDefined(c.colorpickerParent)?a.parent():angular.element(document.body),C=!!angular.isDefined(c.colorpickerWithInput)&&c.colorpickerWithInput,L=angular.isDefined(c.colorpickerSize)?c.colorpickerSize:100,T=L+"px",H=angular.isDefined(c.colorpickerFullSaturation),P=C?'<input type="text" name="colorpicker-input" spellcheck="false">':"",q=y?"":'<button type="button" class="close close-colorpicker">&times;</button>',O='<div class="colorpicker dropdown"><div class="dropdown-menu"><colorpicker-saturation><i></i></colorpicker-saturation><colorpicker-hue><i></i></colorpicker-hue><colorpicker-alpha><i></i></colorpicker-alpha><colorpicker-preview></colorpicker-preview>'+P+'<div><button type="button" class="colorpicker-quickalpha" data-alpha="1"><i class="fa fa-circle-o"></i></button><button type="button" class="colorpicker-quickalpha" data-alpha="0.5"><i class="fa fa-adjust"></i></button><button type="button" class="colorpicker-quickalpha" data-alpha="0"><i class="fa fa-circle"></i></button></div>'+q+'<div><button type="button" class="colorpicker-quickcolor" data-color="rgb(255,0,0)"></button><button type="button" class="colorpicker-quickcolor" data-color="rgb(255,0,255)"></button><button type="button" class="colorpicker-quickcolor" data-color="rgb(0,0,255)"></button><button type="button" class="colorpicker-quickcolor" data-color="rgb(0,255,255)"></button><button type="button" class="colorpicker-quickcolor" data-color="rgb(0,255,0)"></button><button type="button" class="colorpicker-quickcolor" data-color="rgb(255,255,0)"></button></div></div></div>',A=angular.element(O),M=t,B={h:1,s:0,b:1,a:1},D=A.find("colorpicker-hue"),F=A.find("colorpicker-saturation"),V=A.find("colorpicker-preview"),Y=A.find("i"),R=parseInt(L)+29+("rgba"===w?15:0),X=parseInt(L)+55;if(o(A)(l),A.css("min-width",R+"px"),F.css({width:T,height:T}),D.css("height",T),C){var G=A.find("input");G.css("width",T),G.on("mousedown",function(e){e.stopPropagation()}).on("keyup",function(){var e=this.value;/^#([0-9A-Z]{3}){1,2}$/i.test(e)&&(a.val(e),i&&i.$modelValue!==e&&(l.$apply(i.$setViewValue(e)),d(!0)))})}"rgba"===w?(A.addClass("alpha"),x=A.find("colorpicker-alpha"),x.css("height",T),x.on("click",function(e){r.setAlpha(e,S,L),p(e)}).on("mousedown",function(e){r.setAlpha(e,S,L),s()}).on("mouseup",function(e){v("colorpicker-selected-alpha")}),A.find(".colorpicker-quickalpha").on("click",function(e){var o=parseFloat(e.currentTarget.attributes["data-alpha"].value);M.setAlpha.call(M,o),h(),u();var t=M[w]();a.val(t),i&&l.$apply(i.$setViewValue(t)),C&&G.val(t),v("colorpicker-selected-alpha")})):A.find(".colorpicker-quickalpha").hide(),A.find(".colorpicker-quickcolor").on("click",function(e){var o=e.currentTarget.attributes["data-color"].value,t=1-parseFloat(M.value.a);M.setColor(o),M.setAlpha(t),h(),u();var r=M[w]();a.val(r),i&&l.$apply(i.$setViewValue(r)),C&&G.val(r),v("colorpicker-selected-color")}).each(function(){var e=this.attributes["data-color"].value;angular.element(this).css("background-color",e)}),D.on("click",function(e){r.setHue(e,S,L),p(e)}).on("mousedown",function(e){r.setHue(e,S,L),s()}).on("mouseup",function(e){v("colorpicker-selected-hue")}),F.on("click",function(e){r.setSaturation(e,S,L),p(e),angular.isDefined(c.colorpickerCloseOnSelect)&&m()}).on("mousedown",function(e){r.setSaturation(e,S,L),s()}).on("mouseup",function(e){v("colorpicker-selected-saturation")}),S&&A.addClass("colorpicker-fixed-position"),A.addClass("colorpicker-position-"+$),"true"===y&&A.addClass("colorpicker-inline"),I.append(A),i&&(i.$render=function(){a.val(i.$viewValue),d()}),a.on("blur keyup change",function(){d()}),a.on("$destroy",function(){A.remove()});var N=!1;y===!1?(a.on("mousedown",function(){N=A.hasClass("colorpicker-visible")}),a.on("click",b)):b(),A.on("mousedown",function(e){e.stopPropagation(),e.preventDefault()}),A.find("button.close-colorpicker").on("click",function(){m()}),c.colorpickerIsOpen&&l.$watch(c.colorpickerIsOpen,function(e){e===!0?b():e===!1&&m()})}}}]);