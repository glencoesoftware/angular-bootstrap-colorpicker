angular.module("colorpicker.module",[]).factory("Helper",function(){"use strict";return{closestSlider:function(e){var t=e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector;return t.bind(e)("I")?e.parentNode:e},getOffset:function(e,t){for(var o=0,r=0,n=e.getBoundingClientRect();e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop);)t||"BODY"!==e.tagName?(o+=e.scrollLeft,r+=e.scrollTop):(o+=document.documentElement.scrollLeft||e.scrollLeft,r+=document.documentElement.scrollTop||e.scrollTop),e=e.offsetParent;return{top:n.top+window.pageYOffset,left:n.left+window.pageXOffset,scrollX:o,scrollY:r}},stringParsers:[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[e[1],e[2],e[3],e[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[2.55*e[1],2.55*e[2],2.55*e[3],e[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,parse:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,parse:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}}]}}).factory("Color",["Helper",function(e){"use strict";return{value:{h:1,s:1,b:1,a:1},rgb:function(){var e=this.toRGB();return"rgb("+e.r+","+e.g+","+e.b+")"},rgba:function(){var e=this.toRGB();return"rgba("+e.r+","+e.g+","+e.b+","+e.a+")"},hex:function(){return this.toHex()},RGBtoHSB:function(e,t,o,r){e/=255,t/=255,o/=255;var n,i,l,a;return l=Math.max(e,t,o),a=l-Math.min(e,t,o),n=0===a?null:l===e?(t-o)/a:l===t?(o-e)/a+2:(e-t)/a+4,n=(n+360)%6*60/360,i=0===a?0:a/l,{h:n||1,s:i,b:l,a:r||1}},setColor:function(t){t=t?t.toLowerCase():t;for(var o in e.stringParsers)if(e.stringParsers.hasOwnProperty(o)){var r=e.stringParsers[o],n=r.re.exec(t),i=n&&r.parse(n);if(i)return this.value=this.RGBtoHSB.apply(null,i),!1}},setHue:function(e){this.value.h=1-e},setSaturation:function(e){this.value.s=e},setLightness:function(e){this.value.b=1-e},setAlpha:function(e){this.value.a=parseInt(100*(1-e),10)/100},toRGB:function(e,t,o,r){e||(e=this.value.h,t=this.value.s,o=this.value.b),e*=360;var n,i,l,a,c;return e=e%360/60,c=o*t,a=c*(1-Math.abs(e%2-1)),n=i=l=o-c,e=~~e,n+=[c,a,0,0,a,c][e],i+=[a,c,c,a,0,0][e],l+=[0,0,a,c,c,a][e],{r:Math.round(255*n),g:Math.round(255*i),b:Math.round(255*l),a:r||this.value.a}},toHex:function(e,t,o,r){var n=this.toRGB(e,t,o,r);return"#"+(1<<24|parseInt(n.r,10)<<16|parseInt(n.g,10)<<8|parseInt(n.b,10)).toString(16).substr(1)}}}]).factory("Slider",["Helper",function(e){"use strict";var t={maxLeft:0,maxTop:0,callLeft:null,callTop:null,knob:{top:0,left:0}},o={};return{getSlider:function(){return t},getLeftPosition:function(e){return Math.max(0,Math.min(t.maxLeft,t.left+((e.pageX||o.left)-o.left)))},getTopPosition:function(e){return Math.max(0,Math.min(t.maxTop,t.top+((e.pageY||o.top)-o.top)))},setSlider:function(r,n){var i=e.closestSlider(r.target),l=e.getOffset(i,n),a=i.getBoundingClientRect(),c=r.clientX-a.left,s=r.clientY-a.top;t.knob=i.children[0].style,t.left=r.pageX-l.left-window.pageXOffset+l.scrollX,t.top=r.pageY-l.top-window.pageYOffset+l.scrollY,o={left:r.pageX-(c-t.left),top:r.pageY-(s-t.top)}},setSaturation:function(e,o,r){t={maxLeft:r,maxTop:r,callLeft:"setSaturation",callTop:"setLightness"},this.setSlider(e,o)},setHue:function(e,o,r){t={maxLeft:0,maxTop:r,callLeft:!1,callTop:"setHue"},this.setSlider(e,o)},setAlpha:function(e,o,r){t={maxLeft:0,maxTop:r,callLeft:!1,callTop:"setAlpha"},this.setSlider(e,o)},setKnob:function(e,o){t.knob.top=e+"px",t.knob.left=o+"px"}}}]).directive("colorpicker",["$document","$compile","Color","Slider","Helper",function(e,t,o,r,n){"use strict";return{require:"?ngModel",restrict:"A",link:function(i,l,a,c){function s(){e.on("mousemove",u),e.on("mouseup",f)}function p(){try{F.css("backgroundColor",A[w]())}catch(e){F.css("backgroundColor",A.toHex())}D.css("backgroundColor",A.toHex(A.value.h,1,1,1)),"rgba"===w&&(x.css.backgroundColor=A.toHex())}function u(e){var t=r.getLeftPosition(e),o=r.getTopPosition(e),n=r.getSlider();r.setKnob(o,t),n.callLeft&&A[n.callLeft].call(A,t/y),n.callTop&&A[n.callTop].call(A,o/y),T&&"setHue"===n.callTop&&(A.setSaturation.call(A,1),A.setLightness.call(A,0)),p();var a=A[w]();return l.val(a),c&&i.$apply(c.$setViewValue(a)),C&&V.val(a),!1}function f(){v("colorpicker-selected"),e.off("mousemove",u),e.off("mouseup",f)}function d(e){A.setColor(l.val()),C&&!e&&V.val(l.val()),q.eq(0).css({left:A.value.s*y+"px",top:y-A.value.b*y+"px"}),q.eq(1).css("top",y*(1-A.value.h)+"px"),q.eq(2).css("top",y*(1-A.value.a)+"px"),p()}function h(){var e,t=n.getOffset(l[0]);return angular.isDefined(a.colorpickerParent)&&(t.left=0,t.top=0),"top"===S?e={top:t.top-147,left:t.left}:"right"===S?e={top:t.top,left:t.left+126}:"bottom"===S?e={top:t.top+l[0].offsetHeight+2,left:t.left}:"left"===S&&(e={top:t.top,left:t.left-150}),{top:e.top+"px",left:e.left+"px"}}function k(){m()}function g(){M.hasClass("colorpicker-visible")||(d(),M.addClass("colorpicker-visible").css(h()),v("colorpicker-shown"),I===!1&&e.on("mousedown",k),a.colorpickerIsOpen&&(i[a.colorpickerIsOpen]=!0,i.$$phase||i.$digest()))}function v(e){c&&i.$emit(e,{name:a.ngModel,value:c.$modelValue})}function m(){M.hasClass("colorpicker-visible")&&(M.removeClass("colorpicker-visible"),v("colorpicker-closed"),e.off("mousedown",k),a.colorpickerIsOpen&&(i[a.colorpickerIsOpen]=!1,i.$$phase||i.$digest()))}var b,x,w=a.colorpicker?a.colorpicker:"hex",S=angular.isDefined(a.colorpickerPosition)?a.colorpickerPosition:"bottom",I=!!angular.isDefined(a.colorpickerInline)&&a.colorpickerInline,L=!!angular.isDefined(a.colorpickerFixedPosition)&&a.colorpickerFixedPosition,$=angular.isDefined(a.colorpickerParent)?l.parent():angular.element(document.body),C=!!angular.isDefined(a.colorpickerWithInput)&&a.colorpickerWithInput,y=angular.isDefined(a.colorpickerSize)?a.colorpickerSize:100,b=y+"px",T=angular.isDefined(a.colorpickerFullSaturation),H=C?'<input type="text" name="colorpicker-input" spellcheck="false">':"",P=I?"":'<button type="button" class="close close-colorpicker">&times;</button>',O='<div class="colorpicker dropdown"><div class="dropdown-menu"><colorpicker-saturation><i></i></colorpicker-saturation><colorpicker-hue><i></i></colorpicker-hue><colorpicker-alpha><i></i></colorpicker-alpha><colorpicker-preview></colorpicker-preview>'+H+P+'<button type="button" class="colorpicker-quickalpha" data-alpha="1"><i class="fa fa-circle-o"></i></button><button type="button" class="colorpicker-quickalpha" data-alpha="0.5"><i class="fa fa-adjust"></i></button><button type="button" class="colorpicker-quickalpha" data-alpha="0"><i class="fa fa-circle"></i></button></div></div>',M=angular.element(O),A=o,B=M.find("colorpicker-hue"),D=M.find("colorpicker-saturation"),F=M.find("colorpicker-preview"),q=M.find("i");if(t(M)(i),M.css("min-width",parseInt(y)+29+"px"),D.css({width:b,height:b}),B.css("height",b),C){var V=M.find("input");V.css("width",b),V.on("mousedown",function(e){e.stopPropagation()}).on("keyup",function(){var e=this.value;l.val(e),c&&c.$modelValue!==e&&(i.$apply(c.$setViewValue(e)),d(!0))})}"rgba"===w?(M.addClass("alpha"),x=M.find("colorpicker-alpha"),x.css("height",b),x.on("click",function(e){r.setAlpha(e,L,y),u(e)}).on("mousedown",function(e){r.setAlpha(e,L,y),s()}).on("mouseup",function(e){v("colorpicker-selected-alpha")}),M.find(".colorpicker-quickalpha").on("click",function(e){var t=parseFloat(e.currentTarget.attributes["data-alpha"].value);A.setAlpha.call(A,t),p();var o=A[w]();l.val(o),c&&i.$apply(c.$setViewValue(o)),C&&V.val(o),v("colorpicker-selected-alpha")})):M.find(".colorpicker-quickalpha").hide(),B.on("click",function(e){r.setHue(e,L,y),u(e)}).on("mousedown",function(e){r.setHue(e,L,y),s()}).on("mouseup",function(e){v("colorpicker-selected-hue")}),D.on("click",function(e){r.setSaturation(e,L,y),u(e),angular.isDefined(a.colorpickerCloseOnSelect)&&m()}).on("mousedown",function(e){r.setSaturation(e,L,y),s()}).on("mouseup",function(e){v("colorpicker-selected-saturation")}),L&&M.addClass("colorpicker-fixed-position"),M.addClass("colorpicker-position-"+S),"true"===I&&M.addClass("colorpicker-inline"),$.append(M),c&&(c.$render=function(){l.val(c.$viewValue),d()}),l.on("blur keyup change",function(){d()}),l.on("$destroy",function(){M.remove()}),I===!1?l.on("click",g):g(),M.on("mousedown",function(e){e.stopPropagation(),e.preventDefault()}),M.find("button.close-colorpicker").on("click",function(){m()}),a.colorpickerIsOpen&&i.$watch(a.colorpickerIsOpen,function(e){e===!0?g():e===!1&&m()})}}}]);